<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management - Warehouse Transfer Tool</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* File upload styling */
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .upload-area.dragover {
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .upload-area.dragover .upload-icon {
            color: #007bff;
        }
        
        /* Progress bars */
        .upload-progress {
            display: none;
            margin-top: 1rem;
        }
        
        /* Import results */
        .import-results {
            display: none;
            margin-top: 1rem;
        }
        
        .validation-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .validation-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .validation-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        /* Export sections */
        .export-card {
            transition: transform 0.2s ease;
        }
        
        .export-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .export-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }
        
        /* File info display */
        .file-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }
        
        .file-preview {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
        
        /* Summary statistics */
        .summary-stat {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 id="loading-title">Processing...</h5>
            <p id="loading-message" class="text-muted mb-0">Please wait while we process your request</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <a href="index.html" class="btn btn-outline-light me-3">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-database me-2"></i>Data Management
                </span>
            </div>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-bars"></i> Navigate
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="transfer-planning.html">
                            <i class="fas fa-truck text-primary"></i> Transfer Planning
                        </a></li>
                        <li><a class="dropdown-item" href="stockout-management.html">
                            <i class="fas fa-exclamation-triangle text-warning"></i> Stockout Management
                        </a></li>
                        <li><a class="dropdown-item" href="sku-listing.html">
                            <i class="fas fa-list text-success"></i> SKU Listing
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Import Section -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>Import Data
                            <small class="text-muted">Upload Excel or CSV files</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- File Upload Area -->
                        <div id="upload-area" class="upload-area" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h5>Drop files here or click to browse</h5>
                            <p class="text-muted mb-0">
                                Supported formats: Excel (.xlsx, .xls), CSV (.csv)<br>
                                <small>Maximum file size: 50MB</small>
                            </p>
                            <input type="file" id="file-input" class="d-none" accept=".xlsx,.xls,.csv" multiple>
                        </div>

                        <!-- Import Mode Selection -->
                        <div class="import-mode-section mt-3" style="display: none;" id="import-mode-section">
                            <h6><i class="fas fa-cog me-2"></i>Import Mode</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="importMode" id="append-mode" value="append" checked>
                                        <label class="form-check-label" for="append-mode">
                                            <strong>Append Mode (Recommended)</strong>
                                            <div class="form-text">
                                                <i class="fas fa-plus-circle text-success me-1"></i>
                                                <small>Add new records only. Skip existing records without overwriting.</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="importMode" id="overwrite-mode" value="overwrite">
                                        <label class="form-check-label" for="overwrite-mode">
                                            <strong>Overwrite Mode</strong>
                                            <div class="form-text">
                                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                                <small>Update existing records with new data. Use for data corrections.</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary" id="upload-button" onclick="uploadFiles()">
                                    <i class="fas fa-upload me-2"></i>Start Import
                                </button>
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div id="upload-progress" class="upload-progress">
                            <div class="progress mb-2">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div id="upload-status" class="text-muted">Preparing upload...</div>
                        </div>
                        
                        <!-- File Information -->
                        <div id="file-info" class="file-info">
                            <h6>Selected Files:</h6>
                            <div id="file-list"></div>
                        </div>
                        
                        <!-- Import Results -->
                        <div id="import-results" class="import-results">
                            <h6>Import Results:</h6>
                            <div id="import-summary" class="row"></div>
                            <div id="import-messages"></div>
                        </div>
                        
                        <!-- Import Instructions -->
                        <div class="mt-3">
                            <h6>Import Instructions:</h6>
                            <div class="accordion" id="import-instructions">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#inventory-format">
                                            Inventory Data Format
                                        </button>
                                    </h2>
                                    <div id="inventory-format" class="accordion-collapse collapse" data-bs-parent="#import-instructions">
                                        <div class="accordion-body">
                                            <strong>Required columns:</strong> sku_id<br>
                                            <strong>Optional columns:</strong> burnaby_qty, kentucky_qty (at least one required)<br>
                                            <strong>Note:</strong> Supports partial imports - missing quantities default to 0<br>
                                            <strong>Examples:</strong><br>
                                            <code>
                                            <strong>Full Import:</strong><br>
                                            sku_id | burnaby_qty | kentucky_qty<br>
                                            CHG-001 | 500 | 0<br>
                                            CAB-002 | 200 | 150<br><br>
                                            <strong>Burnaby Only:</strong><br>
                                            sku_id | burnaby_qty<br>
                                            CHG-001 | 500<br>
                                            CAB-002 | 200<br><br>
                                            <strong>Kentucky Only:</strong><br>
                                            sku_id | kentucky_qty<br>
                                            CHG-001 | 0<br>
                                            CAB-002 | 150
                                            </code>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sales-format">
                                            Sales Data Format
                                        </button>
                                    </h2>
                                    <div id="sales-format" class="accordion-collapse collapse" data-bs-parent="#import-instructions">
                                        <div class="accordion-body">
                                            <strong>Required columns:</strong> sku_id, year_month, burnaby_sales, kentucky_sales, burnaby_revenue, kentucky_revenue<br>
                                            <strong>Optional columns:</strong> burnaby_stockout_days, kentucky_stockout_days<br>
                                            <strong>Important:</strong> Revenue data is now required for all sales imports. This provides actual dollar amounts for analysis.<br>
                                            <strong>Note:</strong> Stockout days should be 0-31 representing days out of stock during the month<br>
                                            <strong>Example:</strong><br>
                                            <code>
                                            sku_id | year_month | burnaby_sales | kentucky_sales | burnaby_revenue | kentucky_revenue | burnaby_stockout_days | kentucky_stockout_days<br>
                                            CHG-001 | 2024-03 | 50 | 100 | 1275.00 | 2550.00 | 0 | 25<br>
                                            CAB-002 | 2024-03 | 30 | 45 | 262.50 | 393.75 | 5 | 0<br>
                                            DIS-003 | 2024-03 | 0 | 0 | 0.00 | 0.00 | 15 | 30
                                            </code>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sku-format">
                                            SKU Master Data Format
                                        </button>
                                    </h2>
                                    <div id="sku-format" class="accordion-collapse collapse" data-bs-parent="#import-instructions">
                                        <div class="accordion-body">
                                            <strong>Required columns:</strong> sku_id, description, supplier, cost_per_unit<br>
                                            <strong>Optional columns:</strong> status, transfer_multiple, abc_code, xyz_code, category<br>
                                            <strong>Note:</strong> Columns are auto-detected (case-insensitive). Category helps with demand analysis.<br>
                                            <strong>Examples:</strong><br>
                                            <code>
                                            <strong>Basic Format:</strong><br>
                                            sku_id | description | supplier | cost_per_unit<br>
                                            CHG-001 | USB-C Fast Charger 65W | Supplier A | 15.50<br>
                                            CAB-002 | Lightning Cable 3ft | Supplier B | 8.25<br><br>
                                            <strong>With Category:</strong><br>
                                            sku_id | description | supplier | cost_per_unit | category<br>
                                            CHG-001 | USB-C Fast Charger 65W | Supplier A | 15.50 | Chargers<br>
                                            CAB-002 | Lightning Cable 3ft | Supplier B | 8.25 | Cables
                                            </code>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pending-format">
                                            Pending Orders Format
                                        </button>
                                    </h2>
                                    <div id="pending-format" class="accordion-collapse collapse" data-bs-parent="#import-instructions">
                                        <div class="accordion-body">
                                            <strong>Required columns:</strong> sku_id, quantity, destination<br>
                                            <strong>Optional columns:</strong> order_date, expected_date, order_type, status, notes<br>
                                            <strong>Note:</strong> If expected_date is empty, system uses order_date + 120 days (or Today + 120 days if order_date also empty)<br>
                                            <strong>Destinations:</strong> burnaby, kentucky<br>
                                            <strong>Examples:</strong><br>
                                            <code>
                                            <strong>Basic Format:</strong><br>
                                            sku_id | quantity | destination | order_date | expected_date<br>
                                            CHG-001 | 500 | burnaby | 2024-10-15 | 2025-02-15<br>
                                            CAB-002 | 300 | kentucky | 2024-11-01 |<br>
                                            WDG-003 | 200 | burnaby | 2024-11-05 | 2025-03-01<br><br>
                                            <strong>With Details:</strong><br>
                                            sku_id | quantity | destination | order_date | expected_date | order_type | status | notes<br>
                                            CHG-001 | 500 | burnaby | 2024-10-15 | 2025-02-15 | supplier | ordered | Shipment confirmed<br>
                                            CAB-002 | 300 | kentucky | 2024-11-01 | | supplier | ordered | Lead time estimated
                                            </code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Orders Management Section -->
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Pending Orders Management
                            <small class="text-muted">Track and manage incoming inventory orders</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Pending Orders Upload -->
                            <div class="col-lg-6 mb-4">
                                <h6><i class="fas fa-upload me-2"></i>Import Pending Orders</h6>
                                <div id="pending-upload-area" class="upload-area" onclick="document.getElementById('pending-file-input').click()">
                                    <i class="fas fa-calendar-plus upload-icon"></i>
                                    <h6>Drop pending orders file here or click to browse</h6>
                                    <p class="text-muted mb-0">
                                        Upload CSV/Excel with pending inventory orders<br>
                                        <small>Format: sku_id, quantity, destination, expected_date (optional)</small>
                                    </p>
                                </div>
                                <input type="file" id="pending-file-input" accept=".xlsx,.xls,.csv" style="display: none;">

                                <!-- Replace Mode Checkbox -->
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="replace-existing-orders">
                                    <label class="form-check-label" for="replace-existing-orders">
                                        <strong>Replace existing pending orders</strong>
                                        <div class="form-text">
                                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                            <small>If checked, this will delete all existing pending orders before importing new ones</small>
                                        </div>
                                    </label>
                                </div>

                                <!-- Import Progress -->
                                <div id="pending-upload-progress" class="upload-progress">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted mt-1">Processing pending orders...</small>
                                </div>

                                <!-- Import Results -->
                                <div id="pending-import-results" class="import-results"></div>
                            </div>

                            <!-- Pending Orders Summary -->
                            <div class="col-lg-6 mb-4">
                                <h6><i class="fas fa-chart-pie me-2"></i>Current Summary</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="card text-center">
                                            <div class="card-body py-3">
                                                <h4 class="text-primary mb-1" id="pending-total-orders">-</h4>
                                                <small class="text-muted">Total Orders</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center">
                                            <div class="card-body py-3">
                                                <h4 class="text-info mb-1" id="pending-unique-skus">-</h4>
                                                <small class="text-muted">Unique SKUs</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center">
                                            <div class="card-body py-3">
                                                <h4 class="text-success mb-1" id="pending-burnaby-orders">-</h4>
                                                <small class="text-muted">To Burnaby</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card text-center">
                                            <div class="card-body py-3">
                                                <h4 class="text-warning mb-1" id="pending-kentucky-orders">-</h4>
                                                <small class="text-muted">To Kentucky</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Refresh Button -->
                                <div class="d-grid mt-3">
                                    <button class="btn btn-outline-primary" onclick="refreshPendingOrdersSummary()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh Summary
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Orders Table -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6><i class="fas fa-list me-2"></i>Recent Pending Orders</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="showAllPendingOrders()">
                                            <i class="fas fa-external-link-alt me-1"></i>View All
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="clearAllPendingOrders()" title="Clear all pending orders">
                                            <i class="fas fa-trash me-1"></i>Clear All
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="pending-orders-preview">
                                        <thead class="table-light">
                                            <tr>
                                                <th>SKU</th>
                                                <th>Quantity</th>
                                                <th>Destination</th>
                                                <th>Order Date</th>
                                                <th>Expected Date</th>
                                                <th>Status</th>
                                                <th>Days Until</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">
                                                    <em>No pending orders found. Upload pending orders to get started.</em>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination Controls -->
                                <div id="pending-orders-pagination" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                                    <div>
                                        Showing <span id="pending-orders-start">1</span>-<span id="pending-orders-end">10</span>
                                        of <span id="pending-orders-total">0</span> orders
                                    </div>
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item" id="pending-prev-page">
                                                <a class="page-link" href="#" onclick="prevPendingOrdersPage(); return false;">Previous</a>
                                            </li>
                                            <li class="page-item active" id="pending-page-1">
                                                <a class="page-link" href="#" onclick="goToPendingOrdersPage(1); return false;">1</a>
                                            </li>
                                            <li class="page-item" id="pending-page-2">
                                                <a class="page-link" href="#" onclick="goToPendingOrdersPage(2); return false;">2</a>
                                            </li>
                                            <li class="page-item" id="pending-page-3">
                                                <a class="page-link" href="#" onclick="goToPendingOrdersPage(3); return false;">3</a>
                                            </li>
                                            <li class="page-item" id="pending-next-page">
                                                <a class="page-link" href="#" onclick="nextPendingOrdersPage(); return false;">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                    <select class="form-select form-select-sm" style="width: auto" onchange="changePendingOrdersPageSize(this.value)">
                                        <option value="10" selected>10 per page</option>
                                        <option value="20">20 per page</option>
                                        <option value="50">50 per page</option>
                                        <option value="100">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-download me-2"></i>Export Data
                            <small class="text-muted">Download reports and transfer orders</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Transfer Orders Export -->
                            <div class="col-md-6 mb-3">
                                <div class="card export-card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-truck export-icon text-primary"></i>
                                        <h6>Transfer Orders</h6>
                                        <p class="text-muted small">Current transfer recommendations with priorities</p>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary btn-sm" onclick="exportTransferOrders('excel')">
                                                <i class="fas fa-file-excel"></i> Excel
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="exportTransferOrders('csv')">
                                                <i class="fas fa-file-csv"></i> CSV
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inventory Status Export -->
                            <div class="col-md-6 mb-3">
                                <div class="card export-card h-100 text-center">
                                    <div class="card-body">
                                        <i class="fas fa-boxes export-icon text-success"></i>
                                        <h6>Inventory Status</h6>
                                        <p class="text-muted small">Complete inventory report with values</p>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success btn-sm" onclick="exportInventoryStatus()">
                                                <i class="fas fa-file-excel"></i> Excel
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportInventoryStatus('csv')" disabled>
                                                <i class="fas fa-file-csv"></i> CSV (Soon)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export History -->
                        <div class="mt-3">
                            <h6>Recent Exports:</h6>
                            <div id="export-history" class="list-group">
                                <div class="list-group-item text-muted text-center py-4">
                                    No recent exports
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Options -->
                        <div class="mt-3">
                            <h6>Export Options:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-stockout-details" checked>
                                        <label class="form-check-label" for="include-stockout-details">
                                            Include stockout details
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="color-coding" checked>
                                        <label class="form-check-label" for="color-coding">
                                            Color-coded priorities
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-summary" checked>
                                        <label class="form-check-label" for="include-summary">
                                            Include summary sheet
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-formulas" checked>
                                        <label class="form-check-label" for="include-formulas">
                                            Excel formulas
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Statistics -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Database Statistics
                    <button class="btn btn-sm btn-outline-secondary float-end" onclick="refreshStats()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="database-stats">
                    <div class="col-md-2">
                        <div class="summary-stat bg-primary text-white">
                            <span class="stat-number" id="total-skus">--</span>
                            <span class="stat-label">Total SKUs</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-danger text-white">
                            <span class="stat-number" id="out-of-stock">--</span>
                            <span class="stat-label">Out of Stock</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-warning text-dark">
                            <span class="stat-number" id="low-stock">--</span>
                            <span class="stat-label">Low Stock</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-success text-white">
                            <span class="stat-number" id="total-value">--</span>
                            <span class="stat-label">Inventory Value</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-info text-white">
                            <span class="stat-number" id="sales-records">--</span>
                            <span class="stat-label">Sales Records</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-secondary text-white">
                            <span class="stat-number" id="last-import">--</span>
                            <span class="stat-label">Last Import</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center text-secondary py-4 mt-4">
            <small>Data Management System | Last updated: <span id="page-timestamp">--</span></small>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <script>
        // Global variables
        let selectedFiles = [];
        let exportHistory = [];

        // Pagination variables for pending orders
        let currentPendingOrdersPage = 1;
        let pendingOrdersPerPage = 10;
        let totalPendingOrders = 0;
        let totalPendingOrdersPages = 1;

        // Initialize when DOM is ready
        $(document).ready(function() {
            setupFileUpload();
            refreshStats();
            loadExportHistory();
            updateTimestamp();
        });

        // =============================================================================
        // FILE UPLOAD FUNCTIONALITY
        // =============================================================================

        function setupFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File input handler
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            displayFileInfo();

            // Show import mode selection when files are selected
            if (selectedFiles.length > 0) {
                document.getElementById('import-mode-section').style.display = 'block';
            }
        }

        function displayFileInfo() {
            const fileInfo = document.getElementById('file-info');
            const fileList = document.getElementById('file-list');

            if (selectedFiles.length === 0) {
                fileInfo.style.display = 'none';
                return;
            }

            fileInfo.style.display = 'block';
            
            fileList.innerHTML = selectedFiles.map(file => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div>
                        <i class="fas fa-file-${getFileIcon(file.name)} me-2"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted">(${formatFileSize(file.size)})</small>
                    </div>
                    <span class="badge bg-primary">${getFileType(file.name)}</span>
                </div>
            `).join('');
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            showLoading(true, 'Uploading Files', 'Processing your data files...');

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                await uploadSingleFile(file, i + 1, selectedFiles.length);
            }

            showLoading(false);
            refreshStats(); // Refresh stats after import
        }

        async function uploadSingleFile(file, current, total) {
            const formData = new FormData();
            formData.append('file', file);

            // Get selected import mode
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            formData.append('import_mode', importMode);

            const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
            const endpoint = isExcel ? '/api/import/excel' : '/api/import/csv';

            try {
                updateLoadingMessage(`Processing file ${current} of ${total}: ${file.name}`);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                displayImportResults(result, file.name);

                if (result.success) {
                    addToExportHistory('import', file.name, result);
                }

            } catch (error) {
                console.error('Upload error:', error);
                displayImportResults({
                    success: false,
                    filename: file.name,
                    error: `Upload failed: ${error.message}`
                }, file.name);
            }
        }

        function displayImportResults(result, filename) {
            const resultsDiv = document.getElementById('import-results');
            const summaryDiv = document.getElementById('import-summary');
            const messagesDiv = document.getElementById('import-messages');

            resultsDiv.style.display = 'block';

            // Check if we have detailed import results
            const hasDetailedResults = result.results && result.results.some(r => r.import_summary);

            // Update summary statistics
            if (result.success) {
                let totalRecords = result.records_imported || 0;
                let totalSuccessful = 0;
                let totalFailed = 0;
                let totalSkipped = 0;
                let totalWarnings = result.warnings?.length || 0;
                let totalErrors = result.errors?.length || 0;

                // Aggregate detailed results if available
                if (hasDetailedResults) {
                    result.results.forEach(r => {
                        if (r.import_summary) {
                            totalSuccessful += r.import_summary.successful || 0;
                            totalFailed += r.import_summary.failed || 0;
                            totalSkipped += r.import_summary.skipped || 0;
                        }
                    });
                }

                summaryDiv.innerHTML = `
                    <div class="col-md-2">
                        <div class="summary-stat bg-success text-white">
                            <span class="stat-number">${totalSuccessful || totalRecords}</span>
                            <span class="stat-label">Successful</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-danger text-white">
                            <span class="stat-number">${totalFailed}</span>
                            <span class="stat-label">Failed</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-secondary text-white">
                            <span class="stat-number">${totalSkipped}</span>
                            <span class="stat-label">Skipped</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-warning text-dark">
                            <span class="stat-number">${totalWarnings}</span>
                            <span class="stat-label">Warnings</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-info text-white">
                            <span class="stat-number">${result.sheets_processed || 1}</span>
                            <span class="stat-label">Sheets</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-stat bg-primary text-white">
                            <span class="stat-number">${totalSuccessful + totalFailed + totalSkipped}</span>
                            <span class="stat-label">Total Rows</span>
                        </div>
                    </div>
                `;
            }

            // Display messages
            let messagesHtml = '';

            if (result.success) {
                messagesHtml += `<div class="validation-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Successfully processed ${filename}
                </div>`;
            } else {
                messagesHtml += `<div class="validation-error">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Import failed for ${filename}: ${result.error || 'Unknown error'}
                </div>`;
            }

            // Add warnings
            if (result.warnings && result.warnings.length > 0) {
                result.warnings.forEach(warning => {
                    messagesHtml += `<div class="validation-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${warning}
                    </div>`;
                });
            }

            // Add errors
            if (result.errors && result.errors.length > 0) {
                result.errors.forEach(error => {
                    messagesHtml += `<div class="validation-error">
                        <i class="fas fa-times-circle me-2"></i>
                        ${error}
                    </div>`;
                });
            }

            // Add detailed import results if available
            if (hasDetailedResults) {
                messagesHtml += '<div class="mt-4">';

                result.results.forEach((sheetResult, index) => {
                    if (sheetResult.import_details && sheetResult.import_details.length > 0) {
                        const summary = sheetResult.import_summary;
                        const failedItems = sheetResult.import_details.filter(item => item.status === 'failed');
                        const skippedItems = sheetResult.import_details.filter(item => item.status === 'skipped');

                        messagesHtml += `
                            <div class="detailed-results mb-4">
                                <h5 class="text-primary">
                                    <i class="fas fa-table me-2"></i>
                                    Detailed Results: ${summary.successful} successful, ${summary.failed} failed, ${summary.skipped} skipped
                                </h5>
                        `;

                        // Show failed items
                        if (failedItems.length > 0) {
                            messagesHtml += `
                                <div class="mb-3">
                                    <h6 class="text-danger">
                                        <i class="fas fa-times-circle me-2"></i>
                                        Failed Items (${failedItems.length})
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-danger">
                                                <tr>
                                                    <th>Line</th>
                                                    <th>SKU ID</th>
                                                    <th>Error Category</th>
                                                    <th>Error Message</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;

                            failedItems.slice(0, 50).forEach(item => {
                                messagesHtml += `
                                    <tr>
                                        <td>${item.line_number}</td>
                                        <td><code>${item.sku_id}</code></td>
                                        <td><span class="badge bg-danger">${item.error_category}</span></td>
                                        <td>${item.error_message}</td>
                                    </tr>
                                `;
                            });

                            if (failedItems.length > 50) {
                                messagesHtml += `
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            ... and ${failedItems.length - 50} more failed items
                                        </td>
                                    </tr>
                                `;
                            }

                            messagesHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }

                        // Show skipped items
                        if (skippedItems.length > 0) {
                            messagesHtml += `
                                <div class="mb-3">
                                    <h6 class="text-secondary">
                                        <i class="fas fa-minus-circle me-2"></i>
                                        Skipped Items (${skippedItems.length})
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-secondary">
                                                <tr>
                                                    <th>Line</th>
                                                    <th>SKU ID</th>
                                                    <th>Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;

                            skippedItems.slice(0, 20).forEach(item => {
                                messagesHtml += `
                                    <tr>
                                        <td>${item.line_number}</td>
                                        <td><code>${item.sku_id}</code></td>
                                        <td>${item.error_message}</td>
                                    </tr>
                                `;
                            });

                            if (skippedItems.length > 20) {
                                messagesHtml += `
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            ... and ${skippedItems.length - 20} more skipped items
                                        </td>
                                    </tr>
                                `;
                            }

                            messagesHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }

                        // Add export button for failed SKUs
                        if (failedItems.length > 0) {
                            messagesHtml += `
                                <div class="mb-3">
                                    <button class="btn btn-outline-danger btn-sm" onclick="exportFailedSKUs(${index})">
                                        <i class="fas fa-download me-2"></i>
                                        Export Failed SKUs
                                    </button>
                                </div>
                            `;
                        }

                        messagesHtml += '</div>';
                    }
                });

                messagesHtml += '</div>';
            }

            messagesDiv.innerHTML = messagesHtml;

            // Store detailed results for export functionality
            window.lastImportResults = result;
        }

        // Export failed SKUs to CSV
        function exportFailedSKUs(sheetIndex) {
            if (!window.lastImportResults || !window.lastImportResults.results[sheetIndex]) {
                alert('No detailed results available for export');
                return;
            }

            const sheetResult = window.lastImportResults.results[sheetIndex];
            const failedItems = sheetResult.import_details.filter(item => item.status === 'failed');

            if (failedItems.length === 0) {
                alert('No failed items to export');
                return;
            }

            // Create CSV content
            const csvHeader = 'Line Number,SKU ID,Error Category,Error Message,Burnaby Qty,Kentucky Qty\n';
            const csvRows = failedItems.map(item =>
                `${item.line_number},"${item.sku_id}","${item.error_category}","${item.error_message}",${item.burnaby_qty},${item.kentucky_qty}`
            ).join('\n');

            const csvContent = csvHeader + csvRows;

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `failed_skus_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =============================================================================
        // EXPORT FUNCTIONALITY
        // =============================================================================

        async function exportTransferOrders(format = 'excel') {
            showLoading(true, 'Generating Export', `Creating ${format.toUpperCase()} file with transfer recommendations...`);

            try {
                const endpoint = format === 'excel' 
                    ? '/api/export/excel/transfer-orders'
                    : '/api/export/csv/transfer-orders';

                const response = await fetch(endpoint);
                
                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                // Get filename from response headers or create default
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `transfer-orders-${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'csv'}`;

                // Download file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Add to export history
                addToExportHistory('export', filename, {
                    type: 'Transfer Orders',
                    format: format.toUpperCase(),
                    success: true
                });

                showSuccess(`Transfer orders exported successfully as ${filename}`);

            } catch (error) {
                console.error('Export error:', error);
                showError(`Export failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function exportInventoryStatus(format = 'excel') {
            showLoading(true, 'Generating Inventory Report', 'Creating comprehensive inventory status report...');

            try {
                const response = await fetch('/api/export/excel/inventory-status');
                
                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `inventory-status-${new Date().toISOString().split('T')[0]}.xlsx`;

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                addToExportHistory('export', filename, {
                    type: 'Inventory Status',
                    format: 'Excel',
                    success: true
                });

                showSuccess(`Inventory status exported successfully as ${filename}`);

            } catch (error) {
                console.error('Export error:', error);
                showError(`Inventory export failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // =============================================================================
        // STATISTICS AND UTILITIES
        // =============================================================================

        async function refreshStats() {
            try {
                // Get dashboard metrics and SKU count in parallel
                const [dashboardResponse, skuCountResponse] = await Promise.all([
                    fetch('/api/dashboard'),
                    fetch('/api/skus/count')
                ]);

                const data = await dashboardResponse.json();
                const skuCount = await skuCountResponse.json();

                // Update statistics with accurate data
                document.getElementById('total-skus').textContent = skuCount.count;
                document.getElementById('out-of-stock').textContent = data.metrics.out_of_stock;
                document.getElementById('low-stock').textContent = data.metrics.low_stock;
                document.getElementById('total-value').textContent = `$${(data.metrics.total_inventory_value/1000).toFixed(0)}K`;
                document.getElementById('sales-records').textContent = data.metrics.current_month_sales;
                document.getElementById('last-import').textContent = 'Today'; // Placeholder

            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        function addToExportHistory(type, filename, details) {
            const historyItem = {
                timestamp: new Date().toISOString(),
                type: type,
                filename: filename,
                details: details
            };

            exportHistory.unshift(historyItem);
            exportHistory = exportHistory.slice(0, 10); // Keep last 10 items
            
            updateExportHistoryDisplay();
            localStorage.setItem('exportHistory', JSON.stringify(exportHistory));
        }

        function loadExportHistory() {
            const saved = localStorage.getItem('exportHistory');
            if (saved) {
                exportHistory = JSON.parse(saved);
                updateExportHistoryDisplay();
            }
        }

        function updateExportHistoryDisplay() {
            const historyDiv = document.getElementById('export-history');
            
            if (exportHistory.length === 0) {
                historyDiv.innerHTML = '<div class="list-group-item text-muted text-center py-4">No recent exports</div>';
                return;
            }

            historyDiv.innerHTML = exportHistory.map(item => {
                const time = new Date(item.timestamp).toLocaleString();
                const iconClass = item.type === 'import' ? 'fa-upload text-primary' : 'fa-download text-success';
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${iconClass} me-2"></i>
                                <strong>${item.filename}</strong>
                                <br>
                                <small class="text-muted">${time}</small>
                            </div>
                            <span class="badge ${item.details.success ? 'bg-success' : 'bg-danger'}">
                                ${item.details.success ? 'Success' : 'Failed'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions
        function getFileIcon(filename) {
            if (filename.toLowerCase().endsWith('.xlsx') || filename.toLowerCase().endsWith('.xls')) {
                return 'excel';
            } else if (filename.toLowerCase().endsWith('.csv')) {
                return 'csv';
            }
            return 'alt';
        }

        function getFileType(filename) {
            if (filename.toLowerCase().endsWith('.xlsx') || filename.toLowerCase().endsWith('.xls')) {
                return 'Excel';
            } else if (filename.toLowerCase().endsWith('.csv')) {
                return 'CSV';
            }
            return 'Unknown';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showLoading(show, title = 'Processing...', message = 'Please wait while we process your request') {
            const overlay = document.getElementById('loading-overlay');
            const titleEl = document.getElementById('loading-title');
            const messageEl = document.getElementById('loading-message');
            
            if (show) {
                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function updateLoadingMessage(message) {
            document.getElementById('loading-message').textContent = message;
        }

        function showSuccess(message) {
            // You could implement a toast notification here
            alert(message);
        }

        function showError(message) {
            alert(message);
        }

        function updateTimestamp() {
            document.getElementById('page-timestamp').textContent = new Date().toLocaleString();
        }

        // =============================================================================
        // PENDING ORDERS FUNCTIONALITY
        // =============================================================================

        function setupPendingOrdersUpload() {
            const uploadArea = document.getElementById('pending-upload-area');
            const fileInput = document.getElementById('pending-file-input');

            if (!uploadArea || !fileInput) return;

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handlePendingOrdersFile(files[0]);
                }
            });

            // File input handler
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePendingOrdersFile(e.target.files[0]);
                }
            });
        }

        async function handlePendingOrdersFile(file) {
            // Show progress
            const progressContainer = document.getElementById('pending-upload-progress');
            const resultsContainer = document.getElementById('pending-import-results');
            const progressBar = progressContainer.querySelector('.progress-bar');

            progressContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            progressBar.style.width = '10%';

            try {
                // Check if replace mode is enabled
                const replaceMode = document.getElementById('replace-existing-orders').checked;

                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);

                progressBar.style.width = '30%';

                // Build URL with replace parameter
                const url = `/api/pending-orders/import-csv?replace_existing=${replaceMode}`;

                // Upload to pending orders import endpoint
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '80%';

                if (!response.ok) {
                    throw new Error(`Import failed: ${response.statusText}`);
                }

                const result = await response.json();
                progressBar.style.width = '100%';

                // Show results
                displayPendingOrdersImportResults(result);

                // Refresh summary and table
                await refreshPendingOrdersSummary();
                await refreshPendingOrdersPreview();

                // Add to export history
                addToExportHistory('Pending Orders Import', file.name, result);

            } catch (error) {
                console.error('Pending orders import error:', error);
                displayPendingOrdersImportResults({
                    success: false,
                    error: error.message,
                    imported_count: 0,
                    total_orders: 0
                });
            } finally {
                progressContainer.style.display = 'none';
                document.getElementById('pending-file-input').value = '';
            }
        }

        function displayPendingOrdersImportResults(result) {
            const container = document.getElementById('pending-import-results');
            container.style.display = 'block';

            let html = '';

            if (result.success) {
                // Summary section
                const summary = result.summary || {
                    total_rows: result.total_orders,
                    imported: result.imported_count,
                    failed: (result.failed_imports?.length || 0),
                    estimated_dates: result.estimated_dates_added
                };

                html += `<div class="validation-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Import Completed!</strong><br>
                    <div class="row mt-2">
                        <div class="col-3 text-center">
                            <div class="text-success fw-bold fs-5">${summary.imported}</div>
                            <small>Imported</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="text-danger fw-bold fs-5">${summary.failed}</div>
                            <small>Failed</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="text-warning fw-bold fs-5">${summary.estimated_dates}</div>
                            <small>Estimated</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="text-info fw-bold fs-5">${summary.total_rows}</div>
                            <small>Total Rows</small>
                        </div>
                    </div>
                </div>`;

                // Successful imports section
                if (result.successful_imports && result.successful_imports.length > 0) {
                    html += `<div class="mt-3">
                        <button class="btn btn-outline-success btn-sm" data-bs-toggle="collapse" data-bs-target="#successful-imports">
                            <i class="fas fa-check me-1"></i>View ${result.successful_imports.length} Successful Imports
                        </button>
                        <div class="collapse mt-2" id="successful-imports">
                            <div class="card">
                                <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                    <small>
                                        ${result.successful_imports.slice(0, 50).map(item =>
                                            ` ${item.sku_id} (${item.quantity})  ${item.destination}${item.is_estimated ? ' <span class="badge badge-warning">Est.</span>' : ''}`
                                        ).join('<br>')}
                                        ${result.successful_imports.length > 50 ? '<br> ...and ' + (result.successful_imports.length - 50) + ' more' : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }

                // Failed imports section
                if (result.failed_imports && result.failed_imports.length > 0) {
                    html += `<div class="mt-3">
                        <button class="btn btn-outline-danger btn-sm" data-bs-toggle="collapse" data-bs-target="#failed-imports">
                            <i class="fas fa-exclamation-triangle me-1"></i>View ${result.failed_imports.length} Failed Imports
                        </button>
                        <div class="collapse mt-2" id="failed-imports">
                            <div class="card border-danger">
                                <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                    <small>
                                        ${result.failed_imports.slice(0, 25).map(item =>
                                            ` <strong>${item.sku_id}</strong> (${item.quantity})  ${item.destination}<br>&nbsp;&nbsp;<em class="text-danger">${item.error}</em>`
                                        ).join('<br>')}
                                        ${result.failed_imports.length > 25 ? '<br> ...and ' + (result.failed_imports.length - 25) + ' more failures' : ''}
                                    </small>
                                </div>
                                <div class="card-footer p-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="exportFailedImports()">
                                        <i class="fas fa-download me-1"></i>Export Error Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }

                if (result.estimated_dates_added > 0) {
                    html += `<div class="validation-warning mt-3">
                        <i class="fas fa-calendar me-2"></i>
                        ${result.estimated_dates_added} orders used estimated dates (Today + 120 days).
                    </div>`;
                }

            } else {
                html += `<div class="validation-error">
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>Import Failed:</strong> ${result.error || 'Unknown error occurred'}
                </div>`;
            }

            container.innerHTML = html;

            // Store the result for potential export
            window.lastImportResult = result;

            // Auto-hide after 15 seconds if successful
            if (result.success) {
                setTimeout(() => {
                    container.style.display = 'none';
                }, 10000);
            }
        }

        async function refreshPendingOrdersSummary() {
            try {
                const response = await fetch('/api/pending-orders/summary');

                if (!response.ok) {
                    throw new Error('Failed to fetch pending orders summary');
                }

                const result = await response.json();

                if (result.success) {
                    // Update summary statistics directly from API response
                    document.getElementById('pending-total-orders').textContent = result.total_orders || 0;
                    document.getElementById('pending-unique-skus').textContent = result.unique_skus || 0;
                    document.getElementById('pending-burnaby-orders').textContent = result.burnaby_orders || 0;
                    document.getElementById('pending-kentucky-orders').textContent = result.kentucky_orders || 0;
                } else {
                    throw new Error('API returned unsuccessful response');
                }

            } catch (error) {
                console.error('Error refreshing pending orders summary:', error);
                // Set fallback values
                document.getElementById('pending-total-orders').textContent = '-';
                document.getElementById('pending-unique-skus').textContent = '-';
                document.getElementById('pending-burnaby-orders').textContent = '-';
                document.getElementById('pending-kentucky-orders').textContent = '-';
            }
        }

        async function refreshPendingOrdersPreview(page = currentPendingOrdersPage, pageSize = pendingOrdersPerPage) {
            /**
             * Refresh the pending orders preview table with enhanced date display and pagination
             *
             * Features:
             * - Displays both order date and expected/calculated arrival date
             * - Shows visual indicators for estimated vs confirmed dates
             * - Provides tooltips with calculation details
             * - Highlights very old orders (>180 days) with warning colors
             * - Uses proper status badges and color coding
             * - Supports pagination with page and pageSize parameters
             *
             * Date Logic:
             * - If expected_arrival is provided: uses that date with "Conf." badge
             * - If no expected_arrival: calculates order_date + 120 days with "Est." badge
             * - Old orders (>180 days) shown in red with warning tooltip
             *
             * @param {number} page - Page number to load (1-based)
             * @param {number} pageSize - Number of records per page
             * @returns {Promise<void>}
             */
            try {
                const offset = (page - 1) * pageSize;
                const response = await fetch(`/api/pending-orders?limit=${pageSize}&offset=${offset}`);

                if (!response.ok) {
                    throw new Error('Failed to fetch pending orders');
                }

                const result = await response.json();
                const orders = result.data || [];

                // Update pagination variables from API response
                currentPendingOrdersPage = page;
                pendingOrdersPerPage = pageSize;
                totalPendingOrders = result.total || result.count || orders.length;
                totalPendingOrdersPages = result.pages || Math.ceil(totalPendingOrders / pageSize);

                const tbody = document.querySelector('#pending-orders-preview tbody');

                if (orders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <em>No pending orders found.</em>
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = orders.map(order => {
                        const orderDate = new Date(order.order_date).toLocaleDateString();
                        const expectedDate = new Date(order.calculated_arrival_date).toLocaleDateString();
                        const daysUntil = order.days_until_arrival;

                        // Visual indicator for estimated vs confirmed dates
                        const isEstimated = !order.expected_arrival;
                        const daysSinceOrder = Math.ceil((new Date() - new Date(order.order_date)) / (1000 * 60 * 60 * 24));

                        let expectedDateDisplay;
                        if (isEstimated) {
                            const tooltipText = `Estimated arrival: Order date (${orderDate}) + 120 days`;
                            expectedDateDisplay = `<span title="${tooltipText}" data-bs-toggle="tooltip">${expectedDate} <span class="badge bg-warning text-dark ms-1">Est.</span></span>`;
                        } else {
                            const tooltipText = `Confirmed expected arrival date`;
                            expectedDateDisplay = `<span title="${tooltipText}" data-bs-toggle="tooltip">${expectedDate} <span class="badge bg-success text-white ms-1">Conf.</span></span>`;
                        }

                        // Add warning for very old orders (> 180 days)
                        const orderDateClass = daysSinceOrder > 180 ? 'text-danger fw-bold' : 'text-muted';

                        const statusBadge = order.status === 'ordered' ? 'primary' :
                                          order.status === 'shipped' ? 'info' :
                                          order.status === 'received' ? 'success' : 'secondary';

                        return `
                            <tr>
                                <td><code>${order.sku_id}</code></td>
                                <td>${order.quantity.toLocaleString()}</td>
                                <td><span class="badge bg-${order.destination === 'burnaby' ? 'success' : 'warning'}">${order.destination}</span></td>
                                <td class="${orderDateClass}" title="${daysSinceOrder > 180 ? 'Order is very old (>180 days)' : `Order placed ${daysSinceOrder} days ago`}" data-bs-toggle="tooltip">${orderDate}</td>
                                <td>${expectedDateDisplay}</td>
                                <td><span class="badge bg-${statusBadge}">${order.status}</span></td>
                                <td class="${daysUntil < 0 ? 'text-danger' : daysUntil <= 30 ? 'text-warning' : 'text-muted'}">${daysUntil} days</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editPendingOrder(${order.id})"
                                                title="Edit pending order">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deletePendingOrder(${order.id})"
                                                title="Delete pending order">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // Initialize tooltips for the new content
                    const tooltipTriggerList = document.querySelectorAll('#pending-orders-preview [data-bs-toggle="tooltip"]');
                    tooltipTriggerList.forEach(element => {
                        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                            new bootstrap.Tooltip(element);
                        }
                    });
                }

                // Update pagination controls
                updatePendingOrdersPagination();

            } catch (error) {
                console.error('Error refreshing pending orders preview:', error);
                document.querySelector('#pending-orders-preview tbody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <em>Error loading pending orders</em>
                        </td>
                    </tr>
                `;
            }
        }

        function showAllPendingOrders() {
            // This would open a detailed pending orders management page
            // For now, show an alert
            alert('Full pending orders management interface coming soon!');
        }

        async function editPendingOrder(orderId) {
            /**
             * Open edit modal for a pending order with enhanced date handling
             *
             * Features:
             * - Order date field with validation (cannot be in future)
             * - Expected arrival date field (optional)
             * - Real-time calculation display showing final arrival date
             * - Date validation ensuring expected >= order date
             * - Visual feedback for calculated vs user-provided dates
             *
             * Date Calculation Logic:
             * - If user provides expected_arrival: uses that date
             * - If expected_arrival is empty: automatically calculates order_date + 120 days
             * - Shows preview of final calculated date in readonly field
             *
             * @param {number} orderId - ID of the pending order to edit
             * @returns {Promise<void>}
             */
            try {
                // Fetch current order details
                const response = await fetch(`/api/pending-orders/${orderId}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch order details: ${response.statusText}`);
                }

                const result = await response.json();
                const order = result.data;

                // Show edit modal with current values
                showEditPendingOrderModal(order);

            } catch (error) {
                console.error('Error fetching pending order:', error);
                alert(`Failed to load order details: ${error.message}`);
            }
        }

        function showEditPendingOrderModal(order) {
            /**
             * Display the edit modal with current order data pre-filled
             *
             * @param {Object} order - The pending order data to edit
             */
            const modalHtml = `
                <div class="modal fade" id="editPendingOrderModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Pending Order</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editPendingOrderForm">
                                    <input type="hidden" id="edit-order-id" value="${order.id}">

                                    <div class="mb-3">
                                        <label for="edit-sku-id" class="form-label">SKU ID</label>
                                        <input type="text" class="form-control" id="edit-sku-id" value="${order.sku_id}" readonly>
                                        <div class="form-text">SKU cannot be changed after creation</div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-quantity" class="form-label">Quantity *</label>
                                                <input type="number" class="form-control" id="edit-quantity"
                                                       value="${order.quantity}" min="1" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-destination" class="form-label">Destination *</label>
                                                <select class="form-select" id="edit-destination" required>
                                                    <option value="burnaby" ${order.destination === 'burnaby' ? 'selected' : ''}>Burnaby (CA)</option>
                                                    <option value="kentucky" ${order.destination === 'kentucky' ? 'selected' : ''}>Kentucky (US)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-order-date" class="form-label">Order Date *</label>
                                                <input type="date" class="form-control" id="edit-order-date"
                                                       value="${order.order_date}" required max="${new Date().toISOString().split('T')[0]}">
                                                <div class="form-text">Date when the order was placed with supplier</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-expected-date" class="form-label">Expected Arrival</label>
                                                <input type="date" class="form-control" id="edit-expected-date"
                                                       value="${order.expected_arrival || ''}">
                                                <div class="form-text">Leave blank to use Order Date + 120 days</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-status" class="form-label">Status</label>
                                                <select class="form-select" id="edit-status">
                                                    <option value="ordered" ${order.status === 'ordered' ? 'selected' : ''}>Ordered</option>
                                                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                                    <option value="received" ${order.status === 'received' ? 'selected' : ''}>Received</option>
                                                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-calculated-date" class="form-label">Calculated Arrival</label>
                                                <input type="text" class="form-control" id="edit-calculated-date" readonly>
                                                <div class="form-text">Automatically calculated based on dates above</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="edit-is-estimated"
                                               ${order.is_estimated ? 'checked' : ''}>
                                        <label class="form-check-label" for="edit-is-estimated">
                                            Date is estimated (affects confidence weighting)
                                        </label>
                                    </div>

                                    <div class="mb-3">
                                        <label for="edit-notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="edit-notes" rows="2">${order.notes || ''}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="savePendingOrderChanges()">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.getElementById('editPendingOrderModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editPendingOrderModal'));
            modal.show();

            // Add event listeners for date calculation
            const orderDateInput = document.getElementById('edit-order-date');
            const expectedDateInput = document.getElementById('edit-expected-date');
            const calculatedDateInput = document.getElementById('edit-calculated-date');

            function updateCalculatedDate() {
                const orderDate = orderDateInput.value;
                if (orderDate) {
                    // Calculate order date + 120 days
                    const orderDateObj = new Date(orderDate);
                    const calculatedDate = new Date(orderDateObj);
                    calculatedDate.setDate(calculatedDate.getDate() + 120);

                    const calculatedDateStr = calculatedDate.toISOString().split('T')[0];
                    const displayDate = calculatedDate.toLocaleDateString();

                    // Show the calculated date
                    if (expectedDateInput.value) {
                        calculatedDateInput.value = `Using Expected: ${new Date(expectedDateInput.value).toLocaleDateString()}`;
                    } else {
                        calculatedDateInput.value = `${displayDate} (Order + 120 days)`;
                    }
                } else {
                    calculatedDateInput.value = '';
                }
            }

            // Update calculated date when order date or expected date changes
            orderDateInput.addEventListener('change', updateCalculatedDate);
            expectedDateInput.addEventListener('change', updateCalculatedDate);

            // Initialize calculated date display
            updateCalculatedDate();

            // Clean up after modal is hidden
            document.getElementById('editPendingOrderModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        async function savePendingOrderChanges() {
            /**
             * Save changes to the pending order via API
             */
            try {
                const orderId = document.getElementById('edit-order-id').value;
                const quantity = parseInt(document.getElementById('edit-quantity').value);
                const destination = document.getElementById('edit-destination').value;
                const orderDate = document.getElementById('edit-order-date').value;
                const expectedDate = document.getElementById('edit-expected-date').value;
                const status = document.getElementById('edit-status').value;
                const isEstimated = document.getElementById('edit-is-estimated').checked;
                const notes = document.getElementById('edit-notes').value;

                // Validate required fields
                if (!quantity || quantity < 1) {
                    alert('Please enter a valid quantity (minimum 1)');
                    return;
                }

                if (!destination) {
                    alert('Please select a destination');
                    return;
                }

                if (!orderDate) {
                    alert('Please enter an order date');
                    return;
                }

                // Validate order date is not in the future
                const today = new Date().toISOString().split('T')[0];
                if (orderDate > today) {
                    alert('Order date cannot be in the future');
                    return;
                }

                // Validate expected date is after order date if both provided
                if (expectedDate && orderDate && expectedDate < orderDate) {
                    alert('Expected arrival date cannot be before order date');
                    return;
                }

                // Prepare update data
                const updateData = {
                    quantity: quantity,
                    destination: destination,
                    order_date: orderDate,
                    expected_arrival: expectedDate || null,
                    status: status,
                    is_estimated: isEstimated,
                    notes: notes || null
                };

                // Show loading state
                const saveBtn = document.querySelector('#editPendingOrderModal .btn-primary');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
                saveBtn.disabled = true;

                // Send update request
                const response = await fetch(`/api/pending-orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`Update failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPendingOrderModal'));
                modal.hide();

                // Refresh the pending orders table
                await refreshPendingOrdersPreview();

                // Show success message
                showSuccess(`Successfully updated pending order for ${result.data.sku_id}`);

            } catch (error) {
                console.error('Error saving pending order changes:', error);
                alert(`Failed to save changes: ${error.message}`);
            } finally {
                // Restore button state
                const saveBtn = document.querySelector('#editPendingOrderModal .btn-primary');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
                    saveBtn.disabled = false;
                }
            }
        }

        async function deletePendingOrder(orderId) {
            /**
             * Delete a pending order with confirmation
             *
             * @param {number} orderId - ID of the pending order to delete
             */
            try {
                // First fetch order details for confirmation
                const response = await fetch(`/api/pending-orders/${orderId}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch order details: ${response.statusText}`);
                }

                const result = await response.json();
                const order = result.data;

                // Show confirmation dialog
                const confirmed = confirm(
                    `Are you sure you want to delete this pending order?\n\n` +
                    `SKU: ${order.sku_id}\n` +
                    `Quantity: ${order.quantity}\n` +
                    `Destination: ${order.destination}\n` +
                    `Expected: ${order.expected_arrival || 'Estimated'}\n\n` +
                    `This action cannot be undone.`
                );

                if (!confirmed) {
                    return;
                }

                // Delete the order
                const deleteResponse = await fetch(`/api/pending-orders/${orderId}`, {
                    method: 'DELETE'
                });

                if (!deleteResponse.ok) {
                    throw new Error(`Delete failed: ${deleteResponse.statusText}`);
                }

                const deleteResult = await deleteResponse.json();

                // Refresh the pending orders table and summary
                await refreshPendingOrdersPreview();
                await refreshPendingOrdersSummary();

                // Show success message
                showSuccess(`Successfully deleted pending order for ${order.sku_id}`);

            } catch (error) {
                console.error('Error deleting pending order:', error);
                alert(`Failed to delete pending order: ${error.message}`);
            }
        }

        async function clearAllPendingOrders() {
            /**
             * Clear all pending orders with confirmation
             */
            try {
                // Get current count for confirmation
                const summaryResponse = await fetch('/api/pending-orders/summary');
                const summaryData = await summaryResponse.json();
                const totalOrders = summaryData.total_orders || 0;

                if (totalOrders === 0) {
                    alert('No pending orders to delete.');
                    return;
                }

                // Show confirmation dialog
                const confirmed = confirm(
                    `Are you sure you want to delete ALL pending orders?\n\n` +
                    `This will permanently delete ${totalOrders} pending orders.\n\n` +
                    `This action cannot be undone.`
                );

                if (!confirmed) {
                    return;
                }

                // Show loading state
                showLoading(true, 'Clearing Orders', 'Deleting all pending orders...');

                // Delete all pending orders
                const deleteResponse = await fetch('/api/admin/clear-pending-orders', {
                    method: 'POST'
                });

                if (!deleteResponse.ok) {
                    throw new Error(`Clear operation failed: ${deleteResponse.statusText}`);
                }

                const result = await deleteResponse.json();

                // Refresh the pending orders table and summary
                await refreshPendingOrdersPreview();
                await refreshPendingOrdersSummary();

                // Show success message
                showSuccess(`Successfully deleted ${result.deleted_count} pending orders`);

            } catch (error) {
                console.error('Error clearing all pending orders:', error);
                alert(`Failed to clear pending orders: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // =============================================================================
        // PENDING ORDERS PAGINATION FUNCTIONALITY
        // =============================================================================

        function updatePendingOrdersPagination() {
            /**
             * Update pagination controls based on current state
             */
            const paginationDiv = document.getElementById('pending-orders-pagination');
            const startSpan = document.getElementById('pending-orders-start');
            const endSpan = document.getElementById('pending-orders-end');
            const totalSpan = document.getElementById('pending-orders-total');

            if (totalPendingOrders === 0) {
                paginationDiv.style.display = 'none';
                return;
            }

            // Show pagination if we have orders
            paginationDiv.style.display = 'flex';

            // Update range display
            const start = (currentPendingOrdersPage - 1) * pendingOrdersPerPage + 1;
            const end = Math.min(start + pendingOrdersPerPage - 1, totalPendingOrders);

            startSpan.textContent = start;
            endSpan.textContent = end;
            totalSpan.textContent = totalPendingOrders;

            // Update page buttons
            updatePaginationButtons();
        }

        function updatePaginationButtons() {
            /**
             * Update pagination button states
             */
            const prevBtn = document.getElementById('pending-prev-page');
            const nextBtn = document.getElementById('pending-next-page');

            // Enable/disable previous button
            if (currentPendingOrdersPage <= 1) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }

            // Enable/disable next button
            if (currentPendingOrdersPage >= totalPendingOrdersPages) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }

            // Update page number buttons (show current page and nearby pages)
            updatePageNumbers();
        }

        function updatePageNumbers() {
            /**
             * Update the page number buttons to show current and nearby pages
             */
            const pageButtons = document.querySelectorAll('[id^="pending-page-"]');

            // Hide all page buttons first
            pageButtons.forEach(btn => btn.style.display = 'none');

            // Show up to 3 page buttons centered around current page
            for (let i = 1; i <= 3; i++) {
                const pageBtn = document.getElementById(`pending-page-${i}`);
                if (pageBtn) {
                    const pageNum = Math.max(1, currentPendingOrdersPage - 1) + (i - 1);
                    if (pageNum <= totalPendingOrdersPages) {
                        pageBtn.style.display = 'list-item';
                        const link = pageBtn.querySelector('a');
                        link.textContent = pageNum;
                        link.onclick = () => { goToPendingOrdersPage(pageNum); return false; };

                        // Update active state
                        if (pageNum === currentPendingOrdersPage) {
                            pageBtn.classList.add('active');
                        } else {
                            pageBtn.classList.remove('active');
                        }
                    } else {
                        pageBtn.style.display = 'none';
                    }
                }
            }
        }

        function goToPendingOrdersPage(page) {
            /**
             * Navigate to a specific page
             */
            if (page >= 1 && page <= totalPendingOrdersPages && page !== currentPendingOrdersPage) {
                refreshPendingOrdersPreview(page, pendingOrdersPerPage);
            }
        }

        function prevPendingOrdersPage() {
            /**
             * Go to previous page
             */
            if (currentPendingOrdersPage > 1) {
                goToPendingOrdersPage(currentPendingOrdersPage - 1);
            }
        }

        function nextPendingOrdersPage() {
            /**
             * Go to next page
             */
            if (currentPendingOrdersPage < totalPendingOrdersPages) {
                goToPendingOrdersPage(currentPendingOrdersPage + 1);
            }
        }

        function changePendingOrdersPageSize(newSize) {
            /**
             * Change the number of items per page
             */
            pendingOrdersPerPage = parseInt(newSize);
            currentPendingOrdersPage = 1; // Reset to first page
            totalPendingOrdersPages = Math.ceil(totalPendingOrders / pendingOrdersPerPage);
            refreshPendingOrdersPreview(1, pendingOrdersPerPage);
        }

        // Initialize pending orders functionality when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupPendingOrdersUpload();
            refreshPendingOrdersSummary();
            refreshPendingOrdersPreview();
        });
        // Export failed imports to CSV for analysis
        function exportFailedImports() {
            if (!window.lastImportResult || !window.lastImportResult.failed_imports) {
                alert('No failed imports to export');
                return;
            }

            const failedImports = window.lastImportResult.failed_imports;

            // Create CSV content
            let csvContent = 'sku_id,quantity,destination,error\n';
            failedImports.forEach(item => {
                csvContent += `"${item.sku_id}","${item.quantity}","${item.destination}","${item.error.replace(/"/g, '""')}"\n`;
            });

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `failed_imports_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

    </script>
</body>
</html>